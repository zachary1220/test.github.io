<!DOCTYPE html>
<html>
<head>
<title>Accelerometer Data</title>
<style>
  #grant_permission{
    padding: 20px;
    font-size: 30px;
  }
</style>
</head>

<body>
<h2>Accelerometer Data</h2>

<p id='x'>X: </p>
<p id='y'>Y: </p>
<p id='z'>Z: </p>
<p id='motion'>Motion: </p>
<p id='direction'>Direction: </p>
<p id='threshold'>Threshold: </p>
<p id='duration'>Duration: </p>
<p id='count'>Count: </p>

<button id='grant_permission'>Grant Permission</button>

<script>
let display_x = 0, display_y = 0, display_z = 0;
let last_x = 0, last_y = 0, last_z = 0;
let threshold = 3;
let timeThreshold = 0;  // 200ms
let lastTime = 0;
let swingStartTime = 0;
let count = 0;
let countTimeThreshold = 100;  // 100ms
let lastCountTime = 0;
let countStartTime = 0;

function detect_swing(x, y, z, currentTime) {
  var diff_x = x - last_x;
  var diff_y = y - last_y;
  var diff_z = z - last_z;

  last_x = x;
  last_y = y;
  last_z = z;
  
  var max_diff = Math.max(Math.abs(diff_x), Math.abs(diff_y), Math.abs(diff_z));
    
  if (max_diff > threshold && (currentTime - lastTime > timeThreshold)) {
    lastTime = currentTime;

    // Swing duration
    var duration = currentTime - swingStartTime;
    document.getElementById('duration').innerHTML = 'Duration: ' + duration + 'ms';

    // Reset the time when the swing starts
    swingStartTime = currentTime;

    // Tracking count for swings detected in past 100ms
    if (currentTime - countStartTime < countTimeThreshold) {
      count++;
    } else {
      count = 1;
      countStartTime = currentTime;
    }
    document.getElementById('count').innerHTML = 'Count past 100ms: ' + count;

    document.getElementById('threshold').innerHTML = 'Threshold: ' + max_diff;
    return [true, diff_x];
  }
  return [false, 0];
}

document.getElementById('grant_permission').onclick = function() {
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
    .then(permissionState => {
      if (permissionState === 'granted') {
        window.addEventListener('devicemotion', function(event){
          motion(event);
          lastTime = new Date().getTime();
        }, false);
      }
    })
    .catch(console.error);
  } else {
    // handle regular non iOS 14+ devices
    window.addEventListener('devicemotion', function(event){
      motion(event);
      lastTime = new Date().getTime();
    }, false); 
  }

  function motion(event) {
    let x = event.accelerationIncludingGravity.x.toFixed(2);
    let y = event.accelerationIncludingGravity.y.toFixed(2);
    let z = event.accelerationIncludingGravity.z.toFixed(2);
    
    let currentTime = new Date().getTime();
    
    let [isSwinging, direction] = detect_swing(x, y, z, currentTime);
    
    if (isSwinging) {
      document.getElementById('motion').innerHTML = 'Motion: Swing Detected!';
      document.getElementById('direction').innerHTML = 'Direction: ' + (direction > 0 ? 'Left to Right' : 'Right to Left');
    }

    display_x = x;
    display_y = y;
    display_z = z;
  }
  
  setInterval(function(){
    document.getElementById('x').innerHTML = 'X: ' + display_x;
    document.getElementById('y').innerHTML = 'Y: ' + display_y;
    document.getElementById('z').innerHTML = 'Z: ' + display_z;
  }, 1000);
}
</script>

</body>
</html>
