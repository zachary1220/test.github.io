<!DOCTYPE html>
<html>
<head>
<title>Accelerometer Data</title>
<style>
  #grant_permission{
    padding: 20px;
    font-size: 30px;
  }
</style>
</head>

<body>
<h2>Accelerometer Data</h2>

<p id='x'>X: </p>
<p id='y'>Y: </p>
<p id='z'>Z: </p>
<p id='motion'>Motion: </p>
<p id='threshold'>Threshold: </p>

<button id='grant_permission'>授权</button>

<script>
let display_x = 0, display_y = 0, display_z = 0, threshold = 3.5;
let last_x = 0, last_y = 0, last_z = 0;

function detect_swing(x, y, z) {
  var diff_x = Math.abs(last_x - x);
  var diff_y = Math.abs(last_y - y);
  var diff_z = Math.abs(last_z - z);

  last_x = x;
  last_y = y;
  last_z = z;
  
  var max_diff = Math.max(diff_x, diff_y, diff_z);

  if (max_diff > threshold) {
    document.getElementById('threshold').innerHTML = 'Threshold: ' + max_diff;
    return true;
  }
  return false;
}

document.getElementById('grant_permission').onclick = function() {
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
    .then(permissionState => {
      if (permissionState === 'granted') {
        window.addEventListener('devicemotion', motion, false);
      }
    })
    .catch(console.error);
  } else {
    window.addEventListener('devicemotion', motion, false); // handle regular non iOS 13+ devices
  }

  function motion(event) {
    let x = event.accelerationIncludingGravity.x.toFixed(2);
    let y = event.accelerationIncludingGravity.y.toFixed(2);
    let z = event.accelerationIncludingGravity.z.toFixed(2);
    
    if (detect_swing(x, y, z)) {
      document.getElementById('motion').innerHTML = 'Motion: Swing Detected!';
    }

    display_x = x;
    display_y = y;
    display_z = z;
  }
  
  setInterval(function(){
    document.getElementById('x').innerHTML = 'X: ' + display_x;
    document.getElementById('y').innerHTML = 'Y: ' + display_y;
    document.getElementById('z').innerHTML = 'Z: ' + display_z;
  }, 1000);
}
</script>

</body>
</html>
