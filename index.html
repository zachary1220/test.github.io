<!DOCTYPE html>
<html>
<head>
  <title>Device Motion</title>
</head>
<body>
  <p>X: <span id="xVal">0</span></p>
  <p>Y: <span id="yVal">0</span></p>
  <p>Z: <span id="zVal">0</span></p>
  <p>Composite Acceleration: <span id="cVal">0</span></p>
  <p>Status: <span id="status">Stationary</span></p>
  <p>Acceleration Threshold: <input type="range" min="0" max="10" value="0" id="threshold" step="0.1"><span id="thresholdVal">0</span></p>
  <p>Time Threshold (seconds): <input type="range" min="0" max="10" value="2" id="timeThreshold" step="0.1"><span id="timeThresholdVal">2</span></p>
  <button id="requestButton">Request Permission</button>
  <p>Status history:</p>
  <div id="statusHistory" style="height: 500px; overflow: auto; border: 1px solid;"></div>

  <script>
    const xVal = document.getElementById("xVal");
    const yVal = document.getElementById("yVal");
    const zVal = document.getElementById("zVal");
    const cVal = document.getElementById("cVal");
    const status = document.getElementById("status");
    const thresholdSlider = document.getElementById("threshold");
    const thresholdVal = document.getElementById("thresholdVal");
    const timeThresholdSlider = document.getElementById("timeThreshold");
    const timeThresholdVal = document.getElementById("timeThresholdVal");
    const requestButton = document.getElementById("requestButton");
    const statusHistory = document.getElementById("statusHistory");

    let lastMotionTime = null;

    thresholdSlider.addEventListener('input', function() {
      thresholdVal.textContent = thresholdSlider.value;
    });

    timeThresholdSlider.addEventListener('input', function() {
      timeThresholdVal.textContent = timeThresholdSlider.value;
    });

    function getCompositeAcceleration(x, y, z) {
      return Math.sqrt(x * x + y * y + z * z);
    }

    function requestAccess() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(permissionState => {
          if (permissionState === 'granted') {
            window.addEventListener("devicemotion", function(event) {
              xVal.textContent = event.acceleration.x;
              yVal.textContent = event.acceleration.y;
              zVal.textContent = event.acceleration.z;

              const compositeAcceleration = getCompositeAcceleration(event.acceleration.x, event.acceleration.y, event.acceleration.z);
              cVal.textContent = compositeAcceleration;
              
              let newStatus = compositeAcceleration < thresholdSlider.value ? "Stationary" : "In Motion";

              // If it stays stationary for more than the timeThreshold value, then reset lastMotionTime.
              if (newStatus === "Stationary" && lastMotionTime && Date.now() - lastMotionTime >= timeThresholdSlider.value * 1000) {
                lastMotionTime = null;
              }

              // If it's "in motion" and the last status was different, then record the motion time.
              if (newStatus === "In Motion" && newStatus !== status.textContent) {
                lastMotionTime = Date.now();
              }

              if (newStatus !== status.textContent || (newStatus === "In Motion" && Date.now() - lastMotionTime >= timeThresholdSlider.value * 1000)) {
                const timestamp = new Date().toLocaleTimeString();
                const historyRecordText = newStatus === "In Motion"
                  ? `${timestamp} - Status changed to ${newStatus}, composite acceleration is ${compositeAcceleration}` 
                  : `${timestamp} - Status changed to ${newStatus}`;
                const historyRecord = document.createElement("p");
                historyRecord.textContent = historyRecordText;
                statusHistory.insertBefore(historyRecord, statusHistory.firstChild);
                status.textContent = newStatus;
              }
            });
          }
        }).catch(console.error);
      } else {
        // handle regular non iOS 13+ devices
      }
    }

    requestButton.addEventListener('click', requestAccess);
  </script>
</body>
</html>
